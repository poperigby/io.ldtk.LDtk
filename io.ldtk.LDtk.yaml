app-id: io.ldtk.LDtk
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
base: org.electronjs.Electron2.BaseApp
base-version: '23.08'
sdk-extensions:
  - org.freedesktop.Sdk.Extension.ocaml
  - org.freedesktop.Sdk.Extension.node18
command: run.sh
separate-locales: false
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --socket=pipewire
  - --share=network
build-options:
  append-path: 
    # OCaml
  - /usr/lib/sdk/ocaml/bin:/usr/lib/sdk/ocaml/switch/_opam/bin
    # NPM
  - /usr/lib/sdk/node18/bin
  env:
    # OCaml
    CAML_LD_LIBRARY_PATH: /usr/lib/sdk/ocaml/switch/_opam/lib/stublibs:/usr/lib/sdk/ocaml/switch/_opam/lib/ocaml/stublibs:/usr/lib/sdk/ocaml/switch/_opam/lib/ocaml
    OCAML_TOPLEVEL_PATH: /usr/lib/sdk/ocaml/switch/_opam/lib/toplevel
    OPAMROOT: /usr/lib/sdk/ocaml
    OPAMSWITCH: /usr/lib/sdk/ocaml/switch
    OPAM_SWITCH_PREFIX: /usr/lib/sdk/ocaml/switch/_opam
    # NPM
    NPM_CONFIG_LOGLEVEL: info
modules:
  - name: zlib
    sources:
      - type: git
        url: https://github.com/madler/zlib.git
        branch: v1.2.11
    buildsystem: simple
    build-commands:
      - ./configure --prefix=/app
      - make
      - make install
  - name: pcre
    sources:
      - type: git
        url: https://github.com/PhilipHazel/pcre.git
        branch: master
    buildsystem: simple
    build-commands:
      - autoreconf -f -i
      - ./configure --prefix=/app
      - make
      - make install
  - name: haxe
    buildsystem: simple
    sources:
      - haxe-sources.json
    build-commands:
      - >
        . /usr/lib/sdk/ocaml/enable.sh &&
        opam pin -y --assume-depexts hax build/packages/haxe*
  # - name: ldtk
  #   buildsystem: simple
  #   build-options:
  #     env:
  #       XDG_CACHE_HOME: /run/build/ldtk/flatpak-node/cache
  #       npm_config_cache: /run/build/ldtk/flatpak-node/npm-cache
  #       npm_config_offline: 'true'
  #   build-commands:
  #     # Install npm dependencies
  #     - npm install --offline
  #     # Build the app; in this example the `dist` script
  #     # in package.json runs electron-builder
  #     - |
  #       . ../flatpak-node/electron-builder-arch-args.sh
  #       npm run dist -- $ELECTRON_BUILDER_ARCH_ARGS  --linux --dir
  #     # Bundle app and dependencies
  #     - cp -a dist/linux*unpacked /app/main
  #     # Install app wrapper
  #     - install -Dm755 -t /app/bin/ ../run.sh
  #   subdir: main
  #   sources:
  #     #- type: archive
  #     #  url: https://github.com/flathub/ldtk/archive/1.0.1.tar.gz
  #     #  sha256: a2feb3f1cf002a2e4e8900f718cc5c54db4ad174e48bfcfbddcd588c7b716d5b
  #     - type: dir
  #       path: ..
  #       dest: main
  #     - generated-sources.json
  #     # Wrapper to launch the app
  #     - type: script
  #       dest-filename: run.sh
  #       commands:
  #         - zypak-wrapper.sh /app/main/ldtk "$@"
